# WebSocketを利用した〇×ゲーム

## これは何？
WebSocketを利用して、２人のプレイヤーと観客をリアルタイムで通信させつつ、〇×ゲームを行うサンプル。

## 概要
- サイトにアクセスすると、盤面と参加ボタンを表示する。
- 参加ボタンを押すと、サーバーに接続する。
  - １人目の参加を先攻（〇）プレイヤーとする。
    - ２人目が参加するまで、後攻プレイヤーの参加を待つ旨を表示する。
  - ２人目の参加を後攻（×）プレイヤーとする。
    - ２人目の参加時、ゲームを開始する。
  - ３人目以降の接続を、観客とする。
    - 観客の人数はリアルタイムで表示する。
    - 観客の切断を検知した場合も、人数に反映する。
- プレイ状況はリアルタイムで全プレイヤーに通知され、盤面に反映される。
- ゲーム開始時は、先攻プレイヤー・後攻プレイヤーの順に盤面のクリックができる。
  - 自分の番でない場合は、盤面をクリックはできない（反応しない）。
- 勝敗が決定した場合、またはプレイヤーの接続切断を検知した場合、ゲームを終了する。
  - ゲーム終了時は、盤面は消さず、そのまま残す。
  - 〇の勝ち、×の勝ち、切断による終了の終了理由を表示する。
  - 参加ボタンを押すと、次のゲームへの参加を行う。
    - この際、盤面はクリアする。

## クライアント・サーバーの役割と通信に関する技術的方針
- サーバー側・クライアント側共に、クライアント画面に表示する情報（盤面等）を保持する。
  - サーバー側でゲームに関する情報を保持するのは、途中参加の観客にデータを反映する必要があるため。
- 接続クライアントに関する情報は、サーバー側でのみ保持する。
  - ただし、接続数に関する情報は、両方で保持する。
- 最新情報を保持するクライアントに対しては、差分のアクションのみ通知する。
  - 接続開始時には、共有するべき全情報を通知する。
- WebSocketを利用して、リアルタイム通信を行う。
- 通信を行うデータの内容はJSONとする。
  - JSONの内容は、基本的にシリアライズされたReduxアクションとする。
  - 受信したデータはバリデーションを行う。
    - バリデーションエラーがあれば該当クライアントの接続を切断した上で、エラー画面を表示する。

## クライアントに関する技術的方針
- クライアントVite - React - Typescriptの構成とする。
- ステートストアは、Redux Toolkitを利用して構成する。
- サーバー通信を伴う操作
  - サーバー上のステートストアに反映するReduxアクションを送信する。
  - アクションは、JSONによりシリアライズ可能なデータ構造とする。
- サーバー通信を伴わないアクションは、即時反映する。
- サーバーから通知されたアクションは、Reduxアクションとして実行する。
  - Reduxアクションでは、データ（ペイロード）のバリデーションを行う。

## サーバーに関する技術的方針
- サーバーは、"ws"ライブラリを中心に構成する。
  - ステートストアは、クライアントとの整合性を図るため、Redux Toolkitを利用して構成する。
- vite等によるパッケージングは行わず、直接起動する。

## 使用ライブラリ
- 共通
  - Redux Toolkit: ステートストアとして使用する。
  - Zod: バリデーションを行う。TSとの親和性により採用する。
- クライアント
  - React: 仮想DOM。
  - Material-UI (v5): 画面のベースライブラリ。現時点最新のV5の適用を行ってみる。
  - Emotion: MUI V5で推薦されているCSS-in-JS。TSの恩恵を受けるため、オブジェクトスタイルを中心とする。
  - uuid: React Keyの生成や、通信のIDを生成する。
  - eventemitter3: WebSocketの通信ラッパーに使用する。
- サーバー
  - ws: WebSocketライブラリ。
  - winston: ログ出力。
- 開発用
  - 開発環境
    - Vite
  - 開発言語
    - Typescript: 開発言語
    - utility-types: 型の補助ユーティリティ
    - eslint & eslint-plugin-react: リンティング
    - vite-tsconfig-paths: tsconfigのパスをviteに反映
  - テスト関連
    - jest & esbuild-jest: テスト
    - jest-puppeteer & puppeteer: E2Eテスト
    - start-server-and-test: E2Eテスト、サーバーテスト
    - esbuild-register: Typescriptファイルの直接実行

## ディレクトリ構成
- src
  - client: クライアントのみで使用するソースコード、単体テストコード
    - components
      - Providers
        - DialogProvider.tsx: ダイアログを提供する
        - SocketProvider.tsx: ウェブソケット接続を提供する
        - StoreProvider.tsx: ステートストアを提供する
      - Buttons
        - SquareButton.tsx: 盤面上の各マスに配置するボタン
        - ConnectionButton.tsx: 接続・切断のためのボタン
      - Panels
        - BoardPanel.tsx: 盤面
        - AudiencePanel.tsx: 観客数を表示する
        - RolePanel.tsx: 役割を表示する
        - StatusPanel.tsx: ゲームの進行状態を表示する
      - Dialogs
        - Blocker.tsx: 画面操作をブロックする
        - MessageDialog.tsx: メッセージダイアログ
      - Boundaries
        - ErrorBoundary.tsx: 
      - Reactors: UIを持たないが、Reactコンテキストを用いて処理を行うコンポーネント
    - App.tsx
    - main.tsx
  - server: サーバーのみで使用するソースコード、単体テストコード
    - index.ts: サーバーの起動処理等
    - logger.ts: ログの設定
  - store: ステートストア
    - slices: Redux toolkitの「スライス」。Zodでのバリデーション定義含む。
      - display.ts: 盤面を含む、全クライアントの画面に表示する情報の定義とアクション
      - role.ts: クライアントの役割に関する情報の定義とアクション（クライアントのみ）
    - client.ts: サーバー上のストアの定義
    - server.ts: クライアント上でのストアの定義
  - interfaces: インターフェース（通信）専用のコード
  - lib: 共通ライブラリ、単体テストコード
    - tit-tat-toe.ts: 盤面に関する型の定義や勝敗判定を行う。
- test
  - unit: 単体テスト
  - e2e: E2Eテスト（Puppeteerを使用する）
  - server: サーバーテスト
- dist: yarn buildでの生成結果（クライアント）を格納する。

## ソースコード
- eslint
  - Typescriptのおすすめ設定を使用する。
- editorconfig
  - UTF-8 / CRLF
  - インデントは２スペースとする

## テスト（未作成）
- E2Eテスト
  - Puppeteer+Jestを使用する。
- サーバーテスト
  - サーバーを立ち上げた上で、JESTで行う。
- 単体テスト
  - その他の単体テストはJestを使用する。

## ライセンス
MIT
